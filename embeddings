#!python3

import sentence_transformers
import sqlite3
import pickle
import re

# Load the pre-trained model
model = sentence_transformers.SentenceTransformer("all-MiniLM-L12-v2", device="mps")

# Connect to the SQLite database
conn = sqlite3.connect("news.db")
cur = conn.cursor()

cur.execute("SELECT * FROM articles_fts;")
articles = []
titles = []
ids = []
skipped = 0
for i, article in enumerate(cur):
    title = article[0]
    content = article[1]
    id = article[2]

    if content == "":
        skipped += 1
    else:
        content = re.sub(r"[\s]?{.*?}", "", content)
        articles.append(content)
        titles.append(title)
        ids.append(id)

print(f"Skipped {skipped} articles")
print(f"Generating embeddings for {len(articles)} articles")
embeddings = model.encode(articles, show_progress_bar=True)

everything = []
for i, embed in enumerate(embeddings):
    everything.append({"id": ids[i], "title": titles[i], "article": articles[i], "embedding": embed})

with open("dump.pickle", "wb") as f:
    pickle.dump(everything, f)
